

Функция ВычислитьИмяФайлаИПуть(ИмяФайла)
	Каталог = "";
	Пока СтрЧислоВхождений(ИмяФайла, ".") >1 Цикл
		Индекс = Найти(ИмяФайла, ".");
		Каталог = Каталог+Лев(ИмяФайла, Индекс);
		ИмяФайла = Сред(ИмяФайла, Индекс+1, СтрДлина(ИмяФайла));
	КонецЦикла;
	Каталог = СтрЗаменить(Каталог, ".", "\");
	Возврат Каталог;
КонецФункции

Функция ВычислитьПолноеИмяФайла(ИмяФайла, ИмяФайлаСейчас)
	
	ГлавныйПуть = Строка(ЭтотОбъект.Директория);
	Каталог = СтрЗаменить(ИмяФайла, ГлавныйПуть, "");
	ИмяФайла = СтрЗаменить(Каталог, "\", ".");
	
	Каталог = СтрЗаменить(Каталог, ИмяФайлаСейчас, "");
	
	Возврат Каталог;
КонецФункции


Функция ЗаполнитьТаблицу(Директория, Вложенная = Ложь)
	
	МассивФайлов = НайтиФайлы(Директория, "*.*"); 
	Для Каждого Файл ИЗ МассивФайлов Цикл
		Если Файл.ЭтоФайл() Тогда
			ИмяФайла = Файл.Имя;
			Если НЕ Вложенная Тогда
				НоваяСтрока = ЭтотОбъект.Файлы.Добавить();
				НоваяСтрока.ИмяФайла = ИмяФайла;
				НоваяСтрока.Каталог = ВычислитьИмяФайлаИПуть(ИмяФайла);
				НоваяСтрока.НовоеИмя = ИмяФайла;
			Иначе
				НоваяСтрока = ЭтотОбъект.Файлы.Добавить();
				НоваяСтрока.НовоеИмя = ИмяФайла;
				СтароеИмя = Директория+"\"+ИмяФайла;
				НоваяСтрока.Каталог = ВычислитьПолноеИмяФайла(СтароеИмя,ИмяФайла);
				НоваяСтрока.ИмяФайла = СтароеИмя;
			КонецЕсли;
		ИначеЕсли Файл.ЭтоКаталог() Тогда
			ЗаполнитьТаблицу(Директория+"\"+Файл.Имя, Истина);
		КонецЕсли;			
	КонецЦикла;
	
КонецФункции

Функция ЗаполнитьФайлы(Директория) Экспорт
	
	ЭтотОбъект.Файлы.Очистить();
	ЭтотОбъект.Директория = Директория+"\"; 
	ЗаполнитьТаблицу(Директория);
	
КонецФункции

Функция СоздатьЦепочкуКаталогов(Знач Каталог)
	Директория = ЭтотОбъект.Директория;
	   
	ЧастьКаталога = "";
	Пока СтрЧислоВхождений(Каталог, "\") > 0 Цикл
		Индекс = Найти(Каталог, "\");
		ЧастьКаталога = ЧастьКаталога+Лев(Каталог, Индекс);
		СоздатьКаталог(Директория+ЧастьКаталога);
		Каталог = Сред(Каталог, Индекс+1, СтрДлина(Каталог));
	КонецЦикла;
	
КонецФункции

Функция СоздатьКаталогиИФайлы() Экспорт
	//
	Директория = ЭтотОбъект.Директория;
	
	Для Каждого СтрокаФайл ИЗ ЭтотОбъект.Файлы Цикл
		Если СтрокаФайл.Каталог <> "" Тогда //И НЕ СтрокаФайл.Обработано Тогда
			СоздатьЦепочкуКаталогов(СтрокаФайл.Каталог);
			ПереместитьФайл(Директория+СтрокаФайл.ИмяФайла,Директория+СтрокаФайл.Каталог+СтрокаФайл.НовоеИмя);
		КонецЕсли;
		СтрокаФайл.Обработано = Истина;
	КонецЦикла
КонецФункции

Функция ИерархияВФормат1С() Экспорт
	//
	Директория = ЭтотОбъект.Директория;
	
	Для Каждого СтрокаФайл ИЗ ЭтотОбъект.Файлы Цикл
		Если СтрокаФайл.Каталог <> "" Тогда //И НЕ СтрокаФайл.Обработано Тогда
			ПереместитьФайл(Директория+СтрокаФайл.Каталог+СтрокаФайл.НовоеИмя, Директория+СтрокаФайл.ИмяФайла);
		КонецЕсли;
		СтрокаФайл.Обработано = Истина;
	КонецЦикла;
	
	//Уберемся за собой
	МассивФайлов = НайтиФайлы(Директория, "*.*"); 
	Для Каждого Файл ИЗ МассивФайлов Цикл
		Если Файл.ЭтоКаталог() Тогда
			//Сообщить(Файл.ПолноеИмя);
			УдалитьФайлы(Файл.ПолноеИмя);
		КонецЕсли;			
	КонецЦикла;
	
КонецФункции


Функция ЭкспортБДВФайлы(СтруктураДляШаблона) Экспорт 
	
	БД = СтруктураДляШаблона.СтрокаПодключения;
	Пользователь = СтруктураДляШаблона.Пользователь;
	Пароль = СтруктураДляШаблона.Пароль;
	//ШаблонСтрокиСервер = """C:\Program Files\1cv8\common\1cestart.exe"" DESIGNER  /S Server-1C\1C-Work82 /N""Администратор"" /P""12345""";
	ШаблонСтрокиФайл = """C:\Program Files\1cv8\common\1cestart.exe"" DESIGNER  /F"""+БД+""" /N"""+Пользователь+""" /P"""+Пароль+""" /DumpConfigToFiles """+ЭтотОбъект.Директория+"""";
	
	ЗапуститьПриложение(ШаблонСтрокиФайл,,Истина);
	
КонецФункции